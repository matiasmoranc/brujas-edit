<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Tabla de posiciones y goleadores</title>
<style>
  :root{
    --bg:#0f1320; --panel:#151a2c; --muted:#9aa4b2; --text:#e8ecf3;
    --acc:#48a3ff; --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
    --line:#22273d;
  }
  body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
  .wrap{max-width:1000px;margin:24px auto;padding:0 16px}
  .title{display:flex;align-items:center;gap:10px;margin-bottom:14px}
  .tabs{display:flex;gap:8px;margin:25px 10px 10px 10px}
  .tab-btn{border:1px solid var(--line);background:#121731;color:var(--text);padding:10px 14px;border-radius:10px;cursor:pointer}
  .tab-btn.active{background:var(--acc);border-color:var(--acc);color:#04152b}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;overflow:hidden;overflow-x:scroll;}
  table{width:100%;border-collapse:collapse}
  thead th{background:#1b2140;color:#aeb8ca;font-weight:600;text-align:left;padding:10px 12px;font-size:13px;border-bottom:1px solid var(--line)}
  tbody td{padding:10px 12px;border-bottom:1px solid var(--line)}
  tbody tr:hover{background:#151c3a}
  .team{display:flex;align-items:center;gap:10px;font-weight:600}
  .logo{inline-size:26px; block-size:26px; border-radius:6px; background:#0b0f1f;border:1px solid #0d1326; object-fit:cover}
  .dg-pill{font-variant-numeric:tabular-nums;padding:2px 8px;border-radius:999px;font-size:12px}
  .dg-pos{background:rgba(34,197,94,.15);color:var(--ok);border:1px solid rgba(34,197,94,.25)}
  .dg-neg{background:rgba(239,68,68,.15);color:var(--bad);border:1px solid rgba(239,68,68,.25)}
  .pos{width:42px;text-align:right;font-variant-numeric:tabular-nums;color:#cbd5e1}
  .num{font-variant-numeric:tabular-nums;text-align:right}
  .scorer-row{display:grid;grid-template-columns:40px 1fr 90px;gap:12px;align-items:center;padding:10px 12px;border-bottom:1px solid var(--line)}
  .scorer-row:hover{background:#151c3a}
  .rank{color:#aeb8ca;text-align:right}
  .scorer-meta{display:flex;align-items:center;gap:10px}
  .team-chip{font-size:12px;color:#cbd5e1;background:#1b2140;border:1px solid var(--line);padding:2px 6px;border-radius:999px}
  .bar-wrap{background:#0f1530;border:1px solid var(--line);border-radius:999px;inline-size:100%;block-size:10px;overflow:hidden}
  .bar{block-size:100%;background:linear-gradient(90deg,#52a7ff,#7bdcff)}
  .goals{font-variant-numeric:tabular-nums;text-align:right;font-weight:700}
  .hidden{display:none}
  .pad{padding:8px}

  #fechasNav{ display:flex; gap:.5rem; padding:.5rem 15px; overflow:auto; }
  #fechasNav button{
    padding:.4rem .8rem; border:1px solid #2b3245; border-radius:.5rem; background:#fff0; color:#e8ecf3;
    cursor:pointer; transition:.2s;
  }
  #fechasNav button:hover{ transform:translateY(-1px); }
  #fechasNav button.active{ background:#1f2937; border-color:#3b4256; font-weight:700; }
  #fixture{padding: 0; display:grid; gap:.5rem; font-family:system-ui,sans-serif; }
  .head{ display:flex; justify-content:space-between; align-items:center; gap:1rem; }
  .source{ font-size:.9rem; opacity:.8; text-decoration:underline; }
  .match{ display:flex; flex-direction: column;align-items: center; gap:.25rem .75rem; padding:.5rem .75rem; border:1px solid #2b3245; border-radius:.5rem; }
  .teams{ grid-column:1/2; font-weight:600 }
  .meta{ grid-column:1/2; opacity:.75; font-size:.8rem }
  .score{ grid-column:2/3; align-self:center; font-variant-numeric:tabular-nums; font-size:1.3rem; margin-top:-3px }
  .loading,.err{ opacity:.85 }

  /* --- fixtures con escudos --- */
  .teams{ display:grid; grid-template-columns:1fr auto 1fr; align-items:center; gap:8px; font-weight:600 }
  .team-side{ display:flex; align-items:center; gap:8px }
  .team-side.right{ justify-content:start }
  .team-side.left{ flex-direction: row-reverse }
  .team-side span { min-width: 100px; text-align: center; }
  .crest{ inline-size:35px; block-size:35px; border-radius:4px; object-fit:cover; background:#0b0f1f; border:1px solid #0d1326 }
  .vs{ opacity:.7; font-weight:700 }

  /* ---- Editor Ãšltima Fecha ---- */
  .prox-grid{
    display:flex;
    grid-template-columns:1fr auto auto 1fr;
    gap:.5rem;
    align-items:center;
    border:1px solid var(--line);
    border-radius:.5rem;
    padding:.5rem .75rem;
    margin-bottom:.5rem;
  }
  .prox-team{ display:flex; align-items:center; gap:.5rem; font-weight:600; }
  .prox-team img{ inline-size:26px; block-size:26px; border-radius:6px; object-fit:cover; background:#0b0f1f; border:1px solid #0d1326 }
  .prox-vs{ opacity:.7; font-weight:700; }
  .prox-input{
    inline-size:60px;
    text-align:center;
    background:#0f1530; color:var(--text);
    border:1px solid var(--line); border-radius:.5rem; padding:.35rem .2rem;
    font-variant-numeric:tabular-nums;
    max-width: 22px;
  }
  .muted{ color:#aeb8ca; }
  .prox-meta{ font-size:.85rem; opacity:.8; margin-top:-4px; }
</style>
</head>
<body>
<div class="wrap">
  <div class="title">
    <h2 id="titulo">Cargando...</h2>
  </div>

  <div id="fechasNav"></div>
  <div id="fixture"></div>

  <div class="tabs">
    <button class="tab-btn active" data-tab="pos">Posiciones</button>
    <button class="tab-btn" data-tab="goleadores">Goleadores</button>
  </div>

  <div id="tab-pos" class="card">
    <table>
      <thead>
        <tr>
          <th class="pos">#</th>
          <th>Equipo</th>
          <th class="num">PJ</th>
          <th class="num">PG</th>
          <th class="num">PE</th>
          <th class="num">PP</th>
          <th class="num">GF</th>
          <th class="num">GC</th>
          <th>DG</th>
          <th class="num">Pts</th>
        </tr>
      </thead>
      <tbody id="tbody-pos"></tbody>
    </table>
  </div>

  <div id="tab-goleadores" class="card hidden">
    <div id="scorers" class="pad"></div>
  </div>

  <!-- ====== EDICIÃ“N DE RESULTADOS â€” ÃšLTIMA FECHA ====== -->
  <div id="prox-wrapper" class="card" style="margin-top:16px">
    <div class="pad">
      <div class="head">
        <h3 id="prox-title">Editar resultados â€” Ãšltima fecha</h3>
        <div style="display:flex; gap:.5rem; align-items:center">
          <button id="btnVerProyectada" class="tab-btn">Ver tabla proyectada</button>
          <button id="btnVerOficial" class="tab-btn" style="display:none">Ver tabla oficial</button>
        </div>
      </div>

      <div id="prox-content">
        <p class="loading">Buscando Ãºltima fecha jugadaâ€¦</p>
      </div>

      <div style="display:flex; gap:.5rem; margin-top:10px">
        <button id="btnLimpiarProx" class="tab-btn">Limpiar resultados</button>
        <span id="prox-hint" class="muted" style="opacity:.8"></span>
      </div>
    </div>
  </div>
</div>

<script>
  // ====== CONFIG ======
  const WORKER = "https://hidden-recipe-7e2d.mati-moran-castro.workers.dev/"; // Cloudflare Worker
  const LEAGUE_SLUG  = "solymarf8";
  const SEASON_LABEL = "Clausura 2025-Domingo +30";
  const BASE_FIXTURE = `https://insports.uy/liga/${LEAGUE_SLUG}/fixture`;
  const TOTAL_FECHAS = 9;

  // === helpers base (fetch vÃ­a worker + parser a medida) ===
  async function fetchViaWorker(url){
    const r = await fetch(WORKER + encodeURIComponent(url), { cache: "no-store" });
    const txt = await r.text();
    if (!r.ok) throw new Error(`Upstream ${r.status}: ${txt.slice(0,180)}`);
    return txt;
  }
  function buildFixtureUrl(seasonLabel, nroFecha){
    return `${BASE_FIXTURE}/${encodeURIComponent(seasonLabel)}/${nroFecha}/`;
  }
  function parseFixtureDoc(doc){
    const tbody = doc.querySelector('tbody');
    if (!tbody) return [];
    const rows = [...tbody.querySelectorAll('tr')];
    const matches = [];
    const pushMatch = (m) => {
      const norm = s => (s || '').trim().replace(/\s+/g,' ');
      matches.push({
        local:  norm(m.local),
        visita: norm(m.visita),
        gl: m.gl ?? null,
        gv: m.gv ?? null,
        isLibre: !!m.isLibre,
        datetime: norm(m.datetime),
        cancha: norm(m.cancha),
        estado: norm(m.estado),
        logoLocal:  m.logoLocal || '',
        logoVisita: m.logoVisita || ''
      });
    };

    for (let i = 0; i < rows.length; i++) {
      const r = rows[i];

      // A) Jugados (con detalles)
      if (r.matches('tr[class^="detalles-"]')) {
        const det = r;
        const namesRow = det.previousElementSibling || null;
        const logosRow = namesRow?.previousElementSibling || null;

        let local = "", visita = "", logoLocal = "", logoVisita = "";
        if (namesRow) {
          const spans = [...namesRow.querySelectorAll('th span.w3-small')].map(s => s.textContent.trim());
          local  = spans[0] || "";
          visita = spans[1] || "";
        }
        if (logosRow) {
          const imgs = [...logosRow.querySelectorAll('img[alt]')];
          if (imgs[0]) { logoLocal  = imgs[0].getAttribute('src') || '';  local  = local  || imgs[0].getAttribute('alt') || ''; }
          if (imgs[1]) { logoVisita = imgs[1].getAttribute('src') || '';  visita = visita || imgs[1].getAttribute('alt') || ''; }
        }

        const isLibre = /libre/i.test((namesRow?.textContent || logosRow?.textContent || '').trim());

        // fecha/hora + cancha
        const td0 = det.children[0];
        let datetime = "", cancha = "";
        if (td0) {
          const raw = td0.innerText || td0.textContent || "";
          const mDT = raw.match(/\b\d{2}\/\d{2}\/\d{2}\s+\d{1,2}:\d{2}\b/);
          datetime = mDT ? mDT[0] : "";
          const lines = raw.split('\n');
          cancha = (lines[1] || '').replace(/^.*(ðŸ“|map-marker)\s*/i,'').trim();
        }

        const glNode = det.querySelector('h3.w3-leftbar');
        const gvNode = det.querySelector('h3.w3-rightbar');
        const gl = glNode ? Number((glNode.textContent||'').trim()) : null;
        const gv = gvNode ? Number((gvNode.textContent||'').trim()) : null;

        const estado = (det.children[2]?.innerText || det.children[2]?.textContent || "")
                        .toLowerCase().replace(/\s+/g,' ').trim();

        pushMatch({ local, visita, gl, gv, isLibre, datetime, cancha, estado, logoLocal, logoVisita });
        continue;
      }

      // B) Programados (logos/VS â†’ nombres)
      const hasVsTiny = !!r.querySelector('.w3-tiny');
      const next = rows[i+1];
      const isNamesRow = next && next.querySelectorAll('th span.w3-small').length >= 1;
      if (hasVsTiny && isNamesRow) {
        const next2 = rows[i+2];
        if (next2 && next2.matches('tr[class^="detalles-"]')) continue;

        const logosRow = r;
        const namesRow = next;

        const spans = [...namesRow.querySelectorAll('th span.w3-small')].map(s => s.textContent.trim());
        let local  = spans[0] || "";
        let visita = spans[1] || "";

        let logoLocal = "", logoVisita = "";
        const imgs = [...logosRow.querySelectorAll('img[alt]')];
        if (imgs[0]) { logoLocal  = imgs[0].getAttribute('src') || ''; local  = local  || imgs[0].getAttribute('alt') || ''; }
        if (imgs[1]) { logoVisita = imgs[1].getAttribute('src') || ''; visita = visita || imgs[1].getAttribute('alt') || ''; }

        const isLibre = /libre/i.test((namesRow?.textContent || logosRow?.textContent || '').trim());

        pushMatch({
          local, visita, logoLocal, logoVisita,
          gl: null, gv: null, isLibre,
          datetime: "", cancha: "", estado: "programado"
        });

        i = i + 1; // saltar fila de nombres
        continue;
      }

      // C) Libre suelto
      if (/libre/i.test(r.textContent || '')) {
        const next2 = rows[i+1];
        const spans2 = next2 ? [...next2.querySelectorAll('th span.w3-small')].map(s => s.textContent.trim()) : [];
        const team = spans2[0] || "";
        let logoLocal = "";
        const img = r.querySelector('img[alt]');
        if (img) logoLocal = img.getAttribute('src') || '';
        if (team) {
          pushMatch({ local: team, visita: "", gl: null, gv: null, isLibre: true, datetime: "", cancha: "", estado: "programado", logoLocal, logoVisita: "" });
          i = i + 1;
          continue;
        }
      }
    }

    // dedupe
    const seen = new Set();
    const out = [];
    const key = m => [m.local, m.visita, m.datetime || '', m.gl ?? '', m.gv ?? ''].join('||');
    for (const m of matches) { const k = key(m); if (!seen.has(k)) { seen.add(k); out.push(m); } }
    return out;
  }

  async function loadFixtureDate(nroFecha){
    const url  = buildFixtureUrl(SEASON_LABEL, nroFecha);
    const html = await fetchViaWorker(url);
    const doc  = new DOMParser().parseFromString(html, "text/html");
    return { url, matches: parseFixtureDoc(doc) };
  }

  // === UI ===
  const $nav = document.getElementById('fechasNav');
  const $out = document.getElementById('fixture');

  function setActive(n){
    [...$nav.querySelectorAll('button')].forEach(b => {
      b.classList.toggle('active', Number(b.dataset.n) === n);
    });
  }

  async function renderFecha(n){
    try {
      setActive(n);
      const u = new URL(location.href);
      u.searchParams.set('fecha', String(n));
      history.replaceState(null, '', u);

      $out.innerHTML = `<div class="loading">Cargando fecha ${n}â€¦</div>`;
      const { url, matches } = await loadFixtureDate(n);

      $out.innerHTML = `
        <div class="head">
          <h3>Fecha ${n}</h3>
          <a class="source" href="${url}" target="_blank" rel="noopener">Ver en Insports â†—</a>
        </div>
        ${matches.length ? matches.map(m => `
          <div class="match">
            <div class="teams">
              <div class="team-side left">
                ${m.logoLocal ? `<img class="crest" src="${m.logoLocal}" alt="">` : ''}
                <span>${m.local || 'â€”'}</span>
              </div>
              <div class="vs">${m.isLibre ? '' : 'vs'}</div>
              <div class="team-side right">
                ${m.logoVisita ? `<img class="crest" src="${m.logoVisita}" alt="">` : ''}
                <span>${m.visita || (m.isLibre ? 'Libre' : 'â€”')}</span>
              </div>
            </div>
            <div class="score">
              ${(m.gl!=null && m.gv!=null) ? `${m.gl} - ${m.gv}` : (m.isLibre ? 'Libre' : 'â€”')}
            </div>
            <div class="meta">
              ${m.datetime || ''}${m.cancha ? ' | ' + m.cancha : ''}
            </div>
          </div>
        `).join('') : `<p>No hay partidos para la fecha ${n}.</p>`}
      `;
    } catch (e){
      console.error(e);
      $out.innerHTML = `<p class="err">Error: ${e.message}</p>`;
    }
  }

  function hasResultados(matches){
    return matches?.some(m =>
      (Number.isFinite(m.gl) && Number.isFinite(m.gv)) ||
      /final|suspendido|walkover|wo/i.test(m.estado || '')
    );
  }
  async function findUltimaFechaJugada(){
    for (let n = TOTAL_FECHAS; n >= 1; n--){
      try {
        const { matches } = await loadFixtureDate(n);
        if (hasResultados(matches)) return n;
      } catch(_) {}
    }
    return 1;
  }
  async function buildNav(){
    const qs = new URL(location.href).searchParams;
    let start = Number(qs.get('fecha'));
    if (!Number.isFinite(start) || start < 1 || start > TOTAL_FECHAS) {
      start = await findUltimaFechaJugada();
    }
    $nav.innerHTML = Array.from({length: TOTAL_FECHAS}, (_,i)=>i+1)
      .map(n => `<button data-n="${n}" ${n===start?'class="active"':''}>${n}</button>`)
      .join('');
    $nav.addEventListener('click', (e)=>{
      const btn = e.target.closest('button[data-n]');
      if (!btn) return;
      renderFecha(Number(btn.dataset.n));
    });
    renderFecha(start);
  }
  buildNav();

  // ====== ESTADO PARA PROYECCIÃ“N (ÃšLTIMA FECHA) ======
  let BASE_POSICIONES = [];
  let EDIT_FECHA = null;
  let OFFI_MATCHES = [];
  let EDIT_MAP = new Map();
  let MODO_PROYECTADA = false;
  const LS_KEY_PROY = (n) => `edit_fecha_inputs_${n}`;

  // Hook para snapshot de la tabla oficial
  const _renderPos_original = renderPosiciones;
  renderPosiciones = function(rows){
    BASE_POSICIONES = JSON.parse(JSON.stringify(rows||[]));
    _renderPos_original(rows);
  };

  // ====== CARGA DE TABLAS (API) ======
  const API_TABLAS =
    "https://insports.uy/gestion/estadisticas/admin?obtener=tablas&id_campeonato=c535b7a6-85a2-11f0-b455-366f55764788&visibilidad=web";

  fetchJSONWithFallback(API_TABLAS)
    .then(data => {
      render(data);              // llena BASE_POSICIONES vÃ­a hook
      initEdicionUltimaFecha();  // iniciar ediciÃ³n reciÃ©n acÃ¡
    })
    .catch(err => {
      console.error(err);
      document.getElementById('titulo').textContent = "Error al cargar datos";
    });

  async function fetchJSONWithFallback(url){
    try {
      const txt = await fetchViaWorker(url);
      return JSON.parse(txt);
    } catch (e1){
      console.warn("Worker fallÃ³, pruebo AllOrigins:", e1);
      try {
        const r = await fetch(`https://api.allorigins.win/raw?url=${encodeURIComponent(url)}&nocache=${Date.now()}`, { cache:"no-store" });
        if (!r.ok) throw new Error(`AllOrigins ${r.status}`);
        const txt = await r.text();
        return JSON.parse(txt);
      } catch(e2){
        throw new Error(`No se pudo obtener las tablas. Worker: ${e1.message}. AllOrigins: ${e2.message}`);
      }
    }
  }

  // ====== RENDER PRINCIPAL (tolerante) ======
  function render(apiDataD){
    const subtablas = Array.isArray(apiDataD?.Subtablas) ? apiDataD.Subtablas : [];
    const contenedor = subtablas[4];
    if (!contenedor || !Array.isArray(contenedor.Tablas)) {
      document.getElementById('titulo').textContent = "Sin datos de tablas";
      console.warn("Estructura inesperada:", apiDataD);
      return;
    }

    document.getElementById('titulo').textContent = contenedor.Titulo || "Campeonato";
    const posiciones = contenedor.Tablas.find(t => t.Tipo === 'posiciones');
    const goleadores = contenedor.Tablas.find(t => t.Tipo === 'goleadores');
    if(posiciones) renderPosiciones(posiciones.Tabla);
    if(goleadores) renderGoleadores(goleadores.Tabla);
  }

  function renderPosiciones(rows){
    const tbody = document.getElementById('tbody-pos');
    tbody.innerHTML = '';

    const sorted = [...rows].sort((a,b)=>a.Posicion - b.Posicion);
    for(const r of sorted){
      const dg = (r.GF||0) - (r.GC||0);
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="pos">${r.Posicion}</td>
        <td><div class="team">
          <img class="logo" src="${r.Logo_url}" alt="">
          <span>${r.Nombre_equipo}</span>
        </div></td>
        <td class="num">${r.PJ}</td>
        <td class="num">${r.PG}</td>
        <td class="num">${r.PE}</td>
        <td class="num">${r.PP}</td>
        <td class="num">${r.GF}</td>
        <td class="num">${r.GC}</td>
        <td><span class="dg-pill ${dg>=0?'dg-pos':'dg-neg'}">${dg>=0?'+':''}${dg}</span></td>
        <td class="num"><strong>${r.Puntos}</strong></td>
      `;
      tbody.appendChild(tr);
    }
  }

  function renderGoleadores(rows){
    const wrap = document.getElementById('scorers');
    wrap.innerHTML = '';
    const sorted = [...rows].sort((a,b)=>b.Goles - a.Goles);
    const max = Math.max(...sorted.map(s=>s.Goles));

    sorted.forEach((s,i)=>{
      const pct = Math.round((s.Goles/max)*100);
      const div = document.createElement('div');
      div.className = "scorer-row";
      div.innerHTML = `
        <div class="rank">${i+1}</div>
        <div>
          <div class="scorer-meta">
            <img class="logo" src="${s.Logo_url_equipo}" alt="">
            <div>
              <div><strong>${s.Nombre} ${s.Apellido}</strong></div>
              <div class="team-chip">${s.Equipo}</div>
            </div>
          </div>
          <div class="bar-wrap"><div class="bar" style="width:${pct}%"></div></div>
        </div>
        <div class="goals">${s.Goles}</div>
      `;
      wrap.appendChild(div);
    });
  }

  // Tabs
  document.querySelectorAll('.tab-btn[data-tab]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('.tab-btn[data-tab]').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      const tab = btn.dataset.tab;
      document.getElementById('tab-pos').classList.toggle('hidden', tab!=='pos');
      document.getElementById('tab-goleadores').classList.toggle('hidden', tab!=='goleadores');
    });
  });

  // ====== EDICIÃ“N â€” ÃšLTIMA FECHA ======
  async function initEdicionUltimaFecha(){
    try {
      const ultima = await findUltimaFechaJugada();
      EDIT_FECHA = ultima;

      document.getElementById('prox-title').textContent =
        `Editar resultados â€” Ãšltima fecha (Fecha ${EDIT_FECHA})`;

      const { matches } = await loadFixtureDate(EDIT_FECHA);
      // Solo partidos cerrados (no â€œLibreâ€)
      OFFI_MATCHES = matches.filter(m =>
        !m.isLibre && Number.isFinite(m.gl) && Number.isFinite(m.gv)
      );

      // recuperar ediciones previas
      const prev = JSON.parse(localStorage.getItem(LS_KEY_PROY(EDIT_FECHA)) || '{}');
      EDIT_MAP = new Map(Object.entries(prev));

      renderEditorFechaEditable();
      actualizarHint();

      document.getElementById('btnVerProyectada').addEventListener('click', ()=>{
        MODO_PROYECTADA = true;
        document.getElementById('btnVerProyectada').style.display = 'none';
        document.getElementById('btnVerOficial').style.display = '';
        aplicarYRenderProyectada();
      });
      document.getElementById('btnVerOficial').addEventListener('click', ()=>{
        MODO_PROYECTADA = false;
        document.getElementById('btnVerProyectada').style.display = '';
        document.getElementById('btnVerOficial').style.display = 'none';
        _renderPos_original(BASE_POSICIONES);
      });
      document.getElementById('btnLimpiarProx').addEventListener('click', ()=>{
        EDIT_MAP.clear();
        localStorage.removeItem(LS_KEY_PROY(EDIT_FECHA));
        renderEditorFechaEditable();
        if (MODO_PROYECTADA) aplicarYRenderProyectada();
        actualizarHint();
      });

    } catch (e){
      console.error(e);
      const box = document.getElementById('prox-content');
      if (box) box.innerHTML = `<p class="err">No se pudo cargar la Ãºltima fecha: ${e.message}</p>`;
    }
  }

  function renderEditorFechaEditable(){
    const box = document.getElementById('prox-content');
    if (!box) return;

    if (!OFFI_MATCHES.length){
      box.innerHTML = `<p class="muted">No se encontraron partidos cerrados en la Ãºltima fecha.</p>`;
      return;
    }

    const filas = OFFI_MATCHES.map((m,i)=>{
      const key = partidoKey(m, i);
      const edited = EDIT_MAP.get(key) || {};
      const gl = (edited.gl ?? m.gl ?? '');
      const gv = (edited.gv ?? m.gv ?? '');
      const meta = [m.datetime, m.cancha].filter(Boolean).join(' â€¢ ');

      return `
        <div class="prox-grid" data-key="${key}">
          <div class="prox-team">
            ${m.logoLocal ? `<img src="${m.logoLocal}" alt="">` : ''}
            <span>${m.local}</span>
          </div>

          <input class="prox-input" type="number" min="0" inputmode="numeric" placeholder="0" value="${gl}">
          <span class="prox-vs">â€”</span>
          <input class="prox-input" type="number" min="0" inputmode="numeric" placeholder="0" value="${gv}">

          <div class="prox-team" style="justify-self:end">
            ${m.logoVisita ? `<img src="${m.logoVisita}" alt="">` : ''}
            <span>${m.visita}</span>
          </div>

        </div>
      `;
    }).join('');

    box.innerHTML = filas;

    // bind inputs
    box.querySelectorAll('.prox-grid').forEach(row=>{
      const key = row.dataset.key;
      const [inGl, inGv] = row.querySelectorAll('.prox-input');

      const handler = ()=>{
        const gl = parseNum(inGl.value);
        const gv = parseNum(inGv.value);

        if (gl==null && gv==null){
          EDIT_MAP.delete(key);
        } else {
          EDIT_MAP.set(key, { gl, gv });
        }
        persistirInputs();

        // activar proyecciÃ³n automÃ¡ticamente al primer cambio
        if (!MODO_PROYECTADA) {
          MODO_PROYECTADA = true;
          document.getElementById('btnVerProyectada').style.display = 'none';
          document.getElementById('btnVerOficial').style.display = '';
        }
        aplicarYRenderProyectada();
        actualizarHint();
      };

      inGl.addEventListener('input', handler);
      inGv.addEventListener('input', handler);
    });
  }

  function aplicarYRenderProyectada(){
    const proyectada = calcularTablaEditandoFecha(BASE_POSICIONES, OFFI_MATCHES, EDIT_MAP);
    _renderPos_original(proyectada);
  }

  // ===== Utilidades =====
  function parseNum(v){
    if (v==='' || v==null) return null;
    const n = Number(v);
    return (Number.isFinite(n) && n>=0) ? n : null;
  }
  function partidoKey(m, idx){
    return `${m.local}__${m.visita}__${EDIT_FECHA}__${idx}`;
  }
  function persistirInputs(){
    const obj = {};
    for (const [k,v] of EDIT_MAP.entries()) obj[k] = v;
    localStorage.setItem(LS_KEY_PROY(EDIT_FECHA), JSON.stringify(obj));
  }
  function actualizarHint(){
    const hint = document.getElementById('prox-hint');
    if (!hint) return;
    const cargados = Array.from(EDIT_MAP.values()).filter(v => v && (v.gl!=null || v.gv!=null)).length;
    hint.textContent = `Partidos editados: ${cargados}/${OFFI_MATCHES.length}.`;
  }
  function normalizarNombre(s){
    return (s||'').trim().toLowerCase().replace(/\s+/g,' ');
  }
  function cloneStatsRow(r){
    return {
      Nombre_equipo: r.Nombre_equipo,
      Logo_url: r.Logo_url,
      PJ: +r.PJ || 0,
      PG: +r.PG || 0,
      PE: +r.PE || 0,
      PP: +r.PP || 0,
      GF: +r.GF || 0,
      GC: +r.GC || 0,
      Puntos: +r.Puntos || 0
    };
  }

  // Recalcula tabla aplicando cambios sobre la Ãºltima fecha
  function calcularTablaEditandoFecha(baseRows, officialMatches, editsMap){
    const idx = new Map();
    baseRows.forEach(r => idx.set(normalizarNombre(r.Nombre_equipo), cloneStatsRow(r)));

    const aplicarPartido = (L, V, gl, gv, signo) => {
      if (!Number.isFinite(gl) || !Number.isFinite(gv)) return;
      L.PJ += 1*signo; V.PJ += 1*signo;
      L.GF += gl*signo; L.GC += gv*signo;
      V.GF += gv*signo; V.GC += gl*signo;
      if (gl > gv){ L.PG += 1*signo; V.PP += 1*signo; L.Puntos += 3*signo; }
      else if (gl < gv){ V.PG += 1*signo; L.PP += 1*signo; V.Puntos += 3*signo; }
      else { L.PE += 1*signo; V.PE += 1*signo; L.Puntos += 1*signo; V.Puntos += 1*signo; }
    };

    officialMatches.forEach((m, i)=>{
      const L = idx.get(normalizarNombre(m.local));
      const V = idx.get(normalizarNombre(m.visita));
      if (!L || !V) return;

      // 1) quitar resultado oficial
      // aplicarPartido(L, V, m.gl, m.gv, -1);

      // 2) aplicar ediciÃ³n (o reafirmar oficial)
      const key  = partidoKey(m, i);
      const edit = editsMap.get(key);
      const gl2  = (edit && edit.gl!=null) ? edit.gl : m.gl;
      const gv2  = (edit && edit.gv!=null) ? edit.gv : m.gv;

      aplicarPartido(L, V, gl2, gv2, +1);
    });

    const arr = Array.from(idx.values());
    arr.sort((a,b)=>{
      const dgA = (a.GF - a.GC), dgB = (b.GF - b.GC);
      if (b.Puntos !== a.Puntos) return b.Puntos - a.Puntos;
      if (dgB !== dgA) return dgB - dgA;
      if (b.GF !== a.GF) return b.GF - a.GF;
      return a.Nombre_equipo.localeCompare(b.Nombre_equipo, 'es');
    });

    return arr.map((r,i)=>({...r, Posicion:i+1}));
  }
</script>
</body>
</html>
